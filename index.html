<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>CLUSTRO XLSM Safe Uploader</title>
  <style>
    :root { --bg:#0b0d10; --fg:#e7eaf0; --muted:#9aa4b2; --accent:#6aa9ff; }
    html,body{height:100%;}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Apple SD Gothic Neo,AppleGothic,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--fg);}
    header{display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid #1b2230;background:#0d1117;position:sticky;top:0;z-index:10;}
    h1{font-size:16px;margin:0;font-weight:700;letter-spacing:.2px;}
    .muted{color:var(--muted);font-size:12px;}
    main{padding:16px;display:grid;grid-template-columns:1fr;gap:16px;}
    .card{background:#0e141b;border:1px solid #162030;border-radius:12px;box-shadow:0 1px 0 #0a0f15 inset;}
    .card h2{margin:0;padding:12px 14px;border-bottom:1px solid #162030;font-size:14px}
    .card .content{padding:12px 14px;}
    .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    input[type="file"]{padding:8px 10px;background:#0c1219;border:1px solid #1a2636;border-radius:8px;color:var(--fg);}
    select,button{padding:8px 10px;background:#0c1219;border:1px solid #1a2636;border-radius:8px;color:var(--fg);}
    button{cursor:pointer}
    table{width:100%;border-collapse:collapse;font-size:12px}
    th,td{border:1px solid #1b2230;padding:6px 8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    th{background:#0f1620;position:sticky;top:0;z-index:1}
    #sheet{max-width:240px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid #1b2230;border-radius:999px;background:#0c1219}
    .ok{color:#9ae6b4}
    .warn{color:#f6ad55}
    .err{color:#fc8181}
    .hidden{display:none !important}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width: 900px){ .grid2{grid-template-columns:1fr} }
  </style>

  <!-- SheetJS FULL -->
  <script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.20.3/dist/xlsx.full.min.js"></script>
  <!-- JSZip for safe rebuild -->
  <script defer src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
</head>
<body>
  <header>
    <h1>CLUSTRO .XLSM 업로드 호환 모드</h1>
    <span class="muted">매크로는 무시하고 데이터만 읽기</span>
  </header>

  <main>
    <section class="card">
      <h2>1) 파일 업로드</h2>
      <div class="content row">
        <input id="file" type="file"
               accept=".xlsm,.xlsx,application/vnd.ms-excel.sheet.macroEnabled.12,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet">
        <span id="status" class="pill"><span class="warn">●</span><span>대기 중</span></span>
      </div>
    </section>

    <section id="adv" class="card hidden">
      <h2>2) 시트 선택 (자동 인식 실패 시)</h2>
      <div class="content row">
        <label for="sheet">시트:</label>
        <select id="sheet"></select>
        <button id="loadSheet">불러오기</button>
      </div>
    </section>

    <section class="card">
      <h2>미리보기 (상위 200행)</h2>
      <div class="content grid2">
        <div>
          <div class="muted" id="meta">파일/시트 정보 없음</div>
          <div style="max-height:50vh;overflow:auto;border:1px solid #1b2230;border-radius:8px;margin-top:8px">
            <table id="preview"><thead></thead><tbody></tbody></table>
          </div>
        </div>
        <div>
          <h3 style="margin-top:0">필수 열 점검</h3>
          <div id="req" class="muted">점검 전</div>
          <h3>간단 로그</h3>
          <pre id="log" style="background:#0b1118;border:1px solid #172233;border-radius:8px;padding:8px;max-height:50vh;overflow:auto;white-space:pre-wrap"></pre>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ===== 최소 유틸
    const $ = s => document.querySelector(s);
    const log = (...a) => { const el = $("#log"); el.textContent += a.map(x=> typeof x==='string'?x:JSON.stringify(x)).join(' ') + "\n"; el.scrollTop = el.scrollHeight; };
    const setStatus = (type,text) => {
      const el = $("#status"); el.classList.remove('hidden');
      el.innerHTML = '<span class="'+type+'">●</span><span>'+text+'</span>';
    };

    // ===== 프로젝트 훅 (필요시 교체)
    // 실제 앱에서는 rows를 지도/표 로더로 넘기세요.
    async function onExcelRowsLoaded(rows, meta) {
      log("rows:", rows.length, "file:", meta.fileName, "sheet:", meta.sheetName);
      $("#meta").textContent = meta.fileName + "  ·  " + meta.sheetName + "  ·  " + rows.length + " rows";
      renderPreview(rows);
      checkRequiredColumns(rows, ['순번','시설명','구분주소','군집','담당자']);
      setStatus('ok','파싱 완료');
    }

    // ===== 시트 → JSON rows
    function sheetToRows(ws){
      return XLSX.utils.sheet_to_json(ws, { defval: "", raw: true });
    }

    // ===== 미리보기 렌더
    function renderPreview(rows){
      const thead = $("#preview thead");
      const tbody = $("#preview tbody");
      thead.innerHTML = ""; tbody.innerHTML = "";
      if (!rows || !rows.length){ thead.innerHTML = "<tr><th>데이터 없음</th></tr>"; return; }
      const cols = Object.keys(rows[0]);
      thead.innerHTML = "<tr>"+cols.map(c=>"<th>"+escapeHtml(c)+"</th>").join("")+"</tr>";
      for (let i=0;i<Math.min(rows.length,200);i++){
        const r = rows[i];
        const tr = document.createElement("tr");
        tr.innerHTML = cols.map(c=>"<td>"+escapeHtml(String(r[c]))+"</td>").join("");
        tbody.appendChild(tr);
      }
    }
    function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }

    // ===== 필수 열 점검
    function checkRequiredColumns(rows, required){
      if (!rows || !rows.length){ $("#req").innerHTML = "행이 없습니다."; return; }
      const misses = required.filter(k => !(k in rows[0]));
      if (misses.length){
        $("#req").innerHTML = "❌ 누락 열: <b>"+misses.join(", ")+"</b><br><span class='muted'>엑셀의 첫 행(헤더) 열 이름을 확인하세요.</span>";
      } else {
        $("#req").innerHTML = "✅ 필수 열 모두 존재: <b>"+required.join(", ")+"</b>";
      }
    }

    // ===== 파일 읽기 진입
    let wb = null, rows = null, allSheets = null, currentFileName = null;

    $("#file").addEventListener("change", async (e) => {
      const f = e.target.files?.[0]; if (!f) return;
      currentFileName = f.name;
      setStatus('warn','파싱 중…');
      $("#adv").classList.add('hidden');
      try {
        await readFile(f);
      } catch (err) {
        setStatus('err','파싱 실패');
        log("ERR:", err?.message || err);
        alert("엑셀 파싱 실패: " + (err?.message || err));
      } finally {
        // iOS에서 같은 파일 재업로드 허용
        e.target.value = "";
      }
    });

    $("#loadSheet").addEventListener("click", () => {
      if (!wb) return;
      const name = $("#sheet").value;
      const ws = wb.Sheets[name];
      const r = sheetToRows(ws);
      rows = r;
      onExcelRowsLoaded(r, { fileName: currentFileName || "(unknown)", sheetName: name });
    });

    // ===== 핵심: 안전한 XLSM 업로드 파이프라인 =====
    async function readFile(f){
      const buf = await asArray(f);

      // 1차: 일반 경로
      try {
        wb = XLSX.read(buf, { type: 'array', dense: true, cellDates: true });
        log("primary parse ok");
      } catch (e1) {
        log("primary failed:", e1?.message || e1);
        // 2차: 세이프 경로 (vba/customXml 제거 후 재파싱)
        wb = await readXlsmSafely(buf);
        log("safe parse ok");
      }

      allSheets = wb.SheetNames.slice();
      const preferred = "2025DATA";
      if (wb.Sheets[preferred]){
        const ws = wb.Sheets[preferred];
        const r = sheetToRows(ws);
        rows = r;
        onExcelRowsLoaded(r, { fileName: f.name, sheetName: preferred });
      } else {
        // 자동 인식 실패 → 수동 선택
        $("#adv").classList.remove('hidden');
        $("#sheet").innerHTML = allSheets.map(n=>`<option>${n}</option>`).join("");
        setStatus('warn','시트 선택 필요');
      }
    }

    async function asArray(file){
      if (file.arrayBuffer) return file.arrayBuffer();
      return await new Promise((res, rej) => {
        const fr = new FileReader();
        fr.onload = e => res(e.target.result);
        fr.onerror = rej;
        fr.readAsArrayBuffer(file);
      });
    }

    // 세이프 리더: vbaProject.bin / customXml 제거 후 재패키징→파싱
    async function readXlsmSafely(arrayBuffer){
      const zip = await JSZip.loadAsync(arrayBuffer);
      try { zip.remove('xl/vbaProject.bin'); } catch(_){}
      try {
        Object.keys(zip.files).filter(k => k.startsWith('customXml/')).forEach(k => zip.remove(k));
      } catch(_){}
      const rebuilt = await zip.generateAsync({ type:'array' });
      return XLSX.read(rebuilt, { type:'array', dense:true, cellDates:true });
    }

    // (옵션) App.init 훅이 존재한다면 호출해 호환
    window.App = window.App || { init: ()=>log("App.init() (stub)"), };
    document.addEventListener("DOMContentLoaded", () => { try{ App.init(); }catch(e){} });
  </script>
</body>
</html>
